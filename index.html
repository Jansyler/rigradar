<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RigRadar AI - Live Market Scanner</title>
<meta name="description" content="RigRadar AI - Autonomous hardware market scanner. Hunting for PC Hardware, and tech deals 24/7.">

<meta property="og:type" content="website">
<meta property="og:url" content="https://rigradarai.com/">
<meta property="og:title" content="RigRadar AI | Live Market Scanner">
<meta property="og:description" content="AI-driven autonomous scanner hunting for the best hardware deals 24/7.">
<meta property="og:image" content="https://rigradarai.com/social-preview.png">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="RigRadar AI | Live Market Scanner">
<meta name="twitter:description" content="AI-driven autonomous scanner hunting for the best hardware deals 24/7.">
<meta name="twitter:image" content="https://rigradarai.com/social-preview.png">
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { 
            background-color: #050505; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .new-item { animation: fadeIn 0.5s ease-out; }

        /* Support Bot Styles */
        #support-widget { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #support-widget.open { width: 350px; height: 500px; border-radius: 20px; }
        .msg-supp-ai { background: rgba(255, 255, 255, 0.1); border-radius: 12px 12px 12px 0; }
        .msg-supp-user { background: #2563eb; border-radius: 12px 12px 0 12px; }
    </style>
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden">
<div id="notification-container" class="fixed top-5 right-5 z-[1000] flex flex-col gap-3 pointer-events-none"></div>

    <div id="header-placeholder"></div>

    <main class="flex-grow flex flex-col items-center justify-start px-4 pt-32 pb-20 w-full max-w-4xl mx-auto space-y-12">

        <div class="text-center space-y-4">
            <div id="system-status" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 font-mono text-xs uppercase tracking-widest animate-pulse">
                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                System Live & Scanning
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter">
                RIG<span class="text-blue-600">RADAR</span> AI
            </h1>
            <p class="text-gray-400 text-lg max-w-lg mx-auto font-light">
                Autonomous market scanner powered by AI. <br>
                Hunting for the best hardware deals 24/7.
            </p>
        </div>

        <div id="scanner-section" class="glass-panel p-8 md:p-12 rounded-[30px] w-full text-center relative overflow-hidden group transition-all hover:border-blue-500/30">
            <div class="absolute inset-0 bg-blue-600/5 blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
            <div class="relative z-10 space-y-4">
                <div id="product-title" class="text-blue-400 text-xs font-bold uppercase tracking-widest">Searching...</div>
                <div id="price" class="text-4xl md:text-6xl font-black text-white mb-2 tracking-tight break-words">Loading...</div>
                <div class="space-y-2">
                    <div class="text-[10px] uppercase tracking-[0.2em] text-blue-400 font-bold">AI Verdict:</div>
                    <div id="opinion" class="text-gray-300 text-lg italic font-medium leading-relaxed max-w-2xl mx-auto">Connecting to satellite...</div>
                </div>
                <div class="pt-4">
                    <a id="deal-link" href="#" target="_blank" class="hidden inline-block bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl transition-all uppercase text-sm">BUY NOW ‚Üó</a>
                </div>
            </div>
        </div>

<div class="w-full glass-panel p-6 rounded-[20px] relative">
            <div class="flex flex-col mb-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest">Price History</h3>
                    <span class="text-blue-500 text-xs font-mono bg-blue-500/10 px-2 py-1 rounded">Live Trend</span>
                </div>
                <h2 id="chart-title" class="text-xl md:text-2xl font-black text-white mt-1 truncate">Waiting for data...</h2>
            </div>
            <div class="w-full h-48 md:h-64">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div class="w-full space-y-4">
<div class="flex flex-col gap-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="glass-panel p-1 rounded-2xl flex items-center shadow-lg shadow-blue-900/5 ring-1 ring-white/5 focus-within:ring-blue-500/50 transition-all">
                        <span class="pl-4 text-gray-500">üì¶</span>
                        <input type="text" id="scanQuery" placeholder="Product (e.g. RTX 4070)" class="flex-grow bg-transparent border-none text-white px-4 py-4 focus:outline-none placeholder-gray-600 text-base md:text-lg">
                    </div>
                    <div class="glass-panel p-1 rounded-2xl flex items-center shadow-lg shadow-blue-900/5 ring-1 ring-white/5 focus-within:ring-blue-500/50 transition-all">
                        <span class="pl-4 text-gray-500">üè™</span>
                        <input type="text" id="custom-store" placeholder="Store (e.g. Alza, Amazon)" class="flex-grow bg-transparent border-none text-white px-4 py-4 focus:outline-none placeholder-gray-600 text-base md:text-lg">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-panel p-1 rounded-xl flex items-center ring-1 ring-white/5 focus-within:ring-blue-500/50 transition-all">
                        <span class="pl-4 text-gray-500">üí∞</span>
                        <input type="number" id="max-price" placeholder="Max Price ($)" class="flex-grow bg-transparent border-none text-white px-3 py-3 focus:outline-none placeholder-gray-600 text-sm">
                    </div>
                    <div class="glass-panel p-1 rounded-xl flex items-center ring-1 ring-white/5 focus-within:ring-blue-500/50 transition-all relative">
                        <span class="pl-4 text-gray-500">üè∑Ô∏è</span>
                        <select id="condition" class="flex-grow bg-transparent border-none text-gray-400 px-3 py-3 focus:outline-none text-sm appearance-none cursor-pointer">
                            <option value="any" class="bg-gray-900">Any Condition</option>
                            <option value="new" class="bg-gray-900">New Only</option>
                            <option value="used" class="bg-gray-900">Used Only</option>
                        </select>
                        <span class="absolute right-4 text-gray-600 pointer-events-none">‚ñº</span>
                    </div>
                </div>
            </div>
            
            <button onclick="requestScan()" id="scan-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all uppercase tracking-wider text-sm shadow-lg shadow-blue-900/20 active:scale-95">
                RUN RADAR SCAN üöÄ
            </button>
            <div id="scanStatus" class="text-center text-xs font-mono h-5 text-gray-500"></div>
        </div>

        <div class="w-full">
            <div class="flex items-center justify-between mb-6 px-2">
                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest border-l-2 border-blue-500 pl-3">Recent Catches (Live Feed)</h3>
                <span class="text-[10px] text-gray-600 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Real-time
                </span>
            </div>
            <div id="history-list" class="space-y-4">
                <div class="text-center text-gray-700 py-10">Waiting for market data...</div>
            </div>
        </div>

        <div id="detail-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-all opacity-0">
            <div class="glass-panel w-full max-w-lg rounded-[32px] p-8 relative border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.2)] transform scale-95 transition-all duration-300">
                <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl">‚úï</button>
                <div id="modal-badge" class="inline-block px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] uppercase font-bold mb-4 tracking-widest">STORE</div>
                <h2 id="modal-title" class="text-2xl font-black text-white leading-tight mb-2">---</h2>
                <div id="modal-price" class="text-5xl font-black text-blue-500 tracking-tighter mb-6">$---</div>
                <div class="space-y-4">
                    <div class="flex justify-between text-[10px] uppercase font-bold text-gray-500 mb-2"><span>AI Deal Score</span><span id="modal-score-val">---%</span></div>
                    <div class="h-2 bg-black/40 rounded-full overflow-hidden border border-white/5"><div id="modal-score-bar" class="h-full bg-blue-600 transition-all duration-1000" style="width: 0%"></div></div>
                    <div class="pt-4 border-t border-white/5"><div class="text-[10px] uppercase font-bold text-blue-400 mb-2 font-mono">Full AI Analysis</div><p id="modal-opinion" class="text-gray-300 italic leading-relaxed">---</p></div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button id="modal-share" onclick="shareDeal()" class="bg-white/5 hover:bg-white/10 border border-white/10 hover:border-blue-500/30 text-gray-300 hover:text-white font-bold py-4 px-6 rounded-2xl flex items-center justify-center gap-2 transition-all">
                        <span class="text-lg">üîó</span>
                    </button><a id="modal-link" href="#" target="_blank" class="flex-grow bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-center uppercase text-sm tracking-wider">GO TO STORE ‚Üó</a></div>
            </div>
        </div>

<div id="support-widget" class="fixed bottom-6 right-6 z-[200] w-14 h-14 bg-blue-600/20 text-blue-400 rounded-full border border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)] backdrop-blur-md overflow-hidden flex flex-col transition-all duration-300">
            
            <div onclick="toggleSupport()" class="w-full h-14 min-h-[56px] flex items-center justify-center cursor-pointer hover:bg-blue-600/40 transition-all absolute top-0 left-0 z-20 group">
                <span id="supp-icon-open" class="text-2xl group-hover:scale-110 transition-transform">üí¨</span>
                <span id="supp-icon-close" class="text-xl font-black hidden group-hover:scale-110 transition-transform text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">‚úï</span>
            </div>
            
            <div class="flex-1 bg-[#050505]/95 flex flex-col pt-14 opacity-0 transition-opacity duration-300 backdrop-blur-md" id="supp-body">
                <div class="p-3 border-b border-blue-500/20 text-center">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-blue-400 drop-shadow-[0_0_8px_rgba(96,165,250,0.8)]">AI Advisor</h4>
                </div>
                <div id="supp-messages" class="flex-1 overflow-y-auto p-4 space-y-3 text-xs">
                    <div class="msg-supp-ai p-3 text-gray-300 border border-blue-500/20 shadow-[0_0_10px_rgba(37,99,235,0.1)]">Hi! üëã Need help with your build?</div>
                </div>
                <div class="p-3 bg-black/80 border-t border-blue-500/20 flex gap-2">
                    <input id="supp-input" type="text" placeholder="Type here..." onkeypress="if(event.key==='Enter') sendSupportMsg()" class="flex-1 bg-transparent text-white text-xs outline-none">
                    <button onclick="sendSupportMsg()" class="text-blue-500 font-bold text-xs hover:text-cyan-400 transition-colors drop-shadow-[0_0_5px_rgba(96,165,250,0.5)]">SEND</button>
                </div>
            </div>
        </div>
<button onclick="openGuide()" class="fixed bottom-6 left-6 w-14 h-14 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-full border border-blue-500/50 flex items-center justify-center text-2xl font-black backdrop-blur-md transition-all z-[90] shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)] group">
            <span class="group-hover:scale-110 transition-transform">?</span>
        </button>

        <div id="guide-modal" class="fixed inset-0 z-[400] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-all opacity-0">
            <div class="glass-panel w-full max-w-lg rounded-[32px] p-8 relative border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.2)] transform scale-95 transition-all duration-300">
                <button onclick="closeGuide()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl">‚úï</button>
                
                <div class="inline-block px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] uppercase font-bold mb-4 tracking-widest">
                    Quick Start Guide
                </div>
                
                <h2 class="text-2xl font-black text-white leading-tight mb-4">How to use RigRadar üì°</h2>
                
                <p class="text-gray-300 text-sm font-light leading-relaxed mb-6">
                    Simply type the hardware you want (e.g. <span class="text-blue-400 font-mono">RTX 4070</span>), specify a store, and our satellite will autonomously hunt down the absolute best deals in real-time.
                </p>

                <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-2xl mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-[40px] rounded-full pointer-events-none"></div>
                    <div class="flex items-start gap-3 relative z-10">
                        <span class="text-2xl">üí°</span>
                        <div>
                            <h4 class="text-blue-400 font-bold text-sm uppercase tracking-wider mb-1">Pro-Tip: Ask AI First!</h4>
                            <p class="text-xs text-gray-400 leading-relaxed">
                                Don't know what to build? Open <b class="text-white">AI Advisor</b> (top menu). Our AI will recommend the best PC build for your budget and tell you exactly which stores to scan!
                            </p>
                        </div>
                    </div>
                </div>

                <button onclick="closeGuide()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-center uppercase text-sm tracking-wider transition-all shadow-lg shadow-blue-900/20">
                    GOT IT, LET'S SCAN üöÄ
                </button>
            </div>
        </div>
    </main>
    <div id="footer-placeholder"></div>

    <script src="auth.js"></script>
<script>
        // --- SUPPORT BOT LOGIC ---
        let supportHistory = [];
        
        function toggleSupport() {
            const widget = document.getElementById('support-widget');
            const body = document.getElementById('supp-body');
            const iconOpen = document.getElementById('supp-icon-open');
            const iconClose = document.getElementById('supp-icon-close');

            widget.classList.toggle('open');
            
            if (widget.classList.contains('open')) {
                body.classList.remove('opacity-0');
                iconOpen.classList.add('hidden');
                iconClose.classList.remove('hidden');
            } else {
                body.classList.add('opacity-0');
                iconOpen.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        }

        async function sendSupportMsg() {
            const input = document.getElementById('supp-input');
            const msg = input.value.trim();
            if (!msg) return;

            const chat = document.getElementById('supp-messages');
            chat.innerHTML += `<div class="msg-supp-user p-3 text-white self-end ml-auto max-w-[85%]">${msg}</div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;

            supportHistory.push({ role: 'user', text: msg });

            try {
                const res = await fetch('/api/support', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, history: supportHistory })
                });
                const data = await res.json();
                
                chat.innerHTML += `<div class="msg-supp-ai p-3 text-gray-300 max-w-[85%]">${data.text}</div>`;
                supportHistory.push({ role: 'ai', text: data.text });
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {
                chat.innerHTML += `<div class="msg-supp-ai p-3 text-red-400">Connection failed.</div>`;
            }
        }

        // --- POMOCN√Å FUNKCE PRO MOST (Bridge) ---
        function fillScannerFromChat(userMsg) {
            // Zav≈ôe chat
            toggleSupport();
            
            // Vypln√≠ pole pro skenov√°n√≠ t√≠m, na co se u≈æivatel ptal (AI u≈æ mu poradilo)
            const scanInput = document.getElementById('scanQuery');
            scanInput.value = userMsg;
            
            // Efektnƒõ na pole zaost≈ô√≠ (scrollne a problikne)
            scanInput.scrollIntoView({ behavior: "smooth", block: "center" });
            scanInput.parentElement.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => { scanInput.parentElement.classList.remove('ring-2', 'ring-blue-500'); }, 1000);
        }

        // --- NOTIFICATIONS & CHART LOGIC ---
        let lastNotifiedId = null;
        let isFirstLoad = true;
        let isWaitingForScan = false;

        function showRigNotification(title, price, link, deal) {
            const container = document.getElementById('notification-container');
            const id = Date.now();
            
            const notification = document.createElement('div');
            notification.className = "glass-panel pointer-events-auto p-4 rounded-2xl shadow-2xl transform translate-x-full transition-all duration-500 ease-out cursor-pointer hover:border-blue-500/50 min-w-[280px] border border-white/5";
            notification.id = `notif-${id}`;
            notification.style.background = "rgba(10, 10, 10, 0.9)";
            
            notification.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600/20 p-2 rounded-lg text-blue-400">üì°</div>
                    <div class="flex-grow">
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Satellite Found Deal</p>
                        <p class="text-sm font-bold text-white truncate w-48">${title}</p>
                        <p class="text-lg font-black text-green-400 mt-1">${price}</p>
                    </div>
                </div>
            `;

            notification.onclick = () => {
                const dealDataEscaped = encodeURIComponent(JSON.stringify(deal))
                    .replace(/'/g, "%27")
                    .replace(/\(/g, "%28")
                    .replace(/\)/g, "%29");
                openDetail(dealDataEscaped);
                notification.remove();
            };

            container.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);

            setTimeout(() => {
                notification.classList.add('translate-x-[150%]');
                setTimeout(() => notification.remove(), 500);
            }, 6000);
        }

function checkNotifications(deal) {
            if (!deal || !deal.id) return;
            
            // 1. Kdy≈æ u≈æivatel teprve naƒçte web, nic neukazujeme, jen si ulo≈æ√≠me ID posledn√≠ho dealu
            if (isFirstLoad) {
                lastNotifiedId = deal.id;
                isFirstLoad = false;
                return;
            }

            // 2. Kdy≈æ na pozad√≠ p≈ôistane √∫plnƒõ nov√Ω deal
            if (lastNotifiedId !== deal.id) {
                lastNotifiedId = deal.id;
                
                // 3. Uk√°≈æeme popup POUZE pokud si u≈æivatel s√°m p≈ôed chv√≠l√≠ vy≈æ√°dal scan!
                if (isWaitingForScan) {
                    showRigNotification(deal.title, deal.price, deal.url, deal);
                    isWaitingForScan = false; // Popup vyskoƒçil, tak≈æe vypneme "ƒçek√°n√≠"
                }
            }
        }

        // --- MODAL LOGIC ---
        function openDetail(dealDataEscaped) {
            try {
                const deal = JSON.parse(decodeURIComponent(dealDataEscaped));
                const modal = document.getElementById('detail-modal');
                const modalContent = modal.querySelector('div');
                
                document.getElementById('modal-title').innerText = deal.title || "Product Detail";
                document.getElementById('modal-price').innerText = deal.price || "---";
                document.getElementById('modal-opinion').innerText = deal.opinion || "No analysis available.";
                document.getElementById('modal-badge').innerText = (deal.store || "WEB").toUpperCase();
                const score = deal.score || 50;
                document.getElementById('modal-score-val').innerText = score + '%';
                document.getElementById('modal-score-bar').style.width = score + '%';
                const link = document.getElementById('modal-link');
                if (deal.url && deal.url !== "#") { link.href = deal.url; link.classList.remove('hidden'); } 
                else { link.classList.add('hidden'); }

                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
            } catch (e) { console.error("Error opening detail:", e); }
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- CHART LOGIC ---
        let priceChartInstance = null;

        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [], 
                        borderColor: '#3b82f6',
                        borderWidth: 3,
                        backgroundColor: gradient,
                        pointBackgroundColor: '#1a1a1a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#3b82f6',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) { return '$ ' + context.parsed.y.toLocaleString(); }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#666', font: { size: 10 }, maxTicksLimit: 6 }
                        },
                        y: { 
                            display: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#666', callback: function(value) { return '$' + value; } }
                        }
                    }
                }
            });
        }

        async function fetchLatestDeal() {
            try {
                const userEmail = localStorage.getItem('rr_user_email');
                const res = await fetch(`/api/update_price${userEmail ? '?user='+userEmail : ''}`);
                const data = await res.json();
                
                // NOTIFIKACE (Nyn√≠ funguj√≠ spr√°vnƒõ a nespamuj√≠)
                if (data.history && data.history.length > 0) {
                    checkNotifications(data.history[0]);
                } else if (data.latest) {
                    checkNotifications(data.latest);
                }

                // --- HLAVN√ç KARTA ---
                if (data.latest) {
                    const priceEl = document.getElementById('price');
                    const opinionEl = document.getElementById('opinion');
                    const titleEl = document.getElementById('product-title');
                    const btn = document.getElementById('deal-link');

                    let cleanPrice = data.latest.price || "---";
                    if(cleanPrice.includes(":")) cleanPrice = cleanPrice.split(":")[1].trim();

                    if(priceEl) priceEl.innerText = cleanPrice;
                    if(opinionEl) opinionEl.innerText = data.latest.opinion || "Scanning market...";
                    if(titleEl) titleEl.innerText = data.latest.title || "Latest Catch";
                    
                    if (btn && data.latest.url && data.latest.url !== "#") {
                        btn.href = data.latest.url;
                        btn.classList.remove('hidden');
                    }

                    // --- UPDATE GRAFU ---
                    if (priceChartInstance && data.history) {
                        const searchQuery = document.getElementById('scanQuery').value.trim().toLowerCase();
                        const activeTitle = data.latest.title || "Unknown Product";
                        
                        const chartTitleEl = document.getElementById('chart-title');
                        if(chartTitleEl) chartTitleEl.innerText = activeTitle.split(' ').slice(0, 6).join(' ');

                        const keywords = searchQuery ? searchQuery : activeTitle.split(' ').slice(0, 2).join(' ').toLowerCase();
                        const allDeals = [data.latest, ...data.history];
                        
                        const relevantDeals = allDeals.filter(d => d.title && d.title.toLowerCase().includes(keywords));

                        const chartPrices = [];
                        const chartLabels = [];

                        relevantDeals.forEach(d => {
                            const p = parseFloat(d.price.toString().replace(/[^0-9.]/g, ''));
                            if (!isNaN(p)) {
                                chartPrices.push(p);
                                const date = new Date(d.timestamp);
                                const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                chartLabels.push(`${day} ${time}`);
                            }
                        });

                        if (chartPrices.length > 0) {
                            priceChartInstance.data.datasets[0].data = chartPrices.reverse();
                            priceChartInstance.data.labels = chartLabels.reverse();
                            priceChartInstance.update();
                        }
                    }
                }

                // --- LIST UPDATE ---
                const list = document.getElementById('history-list');
                const savedIds = (data.saved || []).map(s => s.id);

                if (list && data.history && Array.isArray(data.history)) {
                    const limitedHistory = data.history.slice(0, 5); 
                    let htmlContent = '';
                    limitedHistory.forEach((deal, index) => {
                        let timeText = "Now";
                        if (deal.timestamp) {
                            const diffMs = Date.now() - deal.timestamp;
                            const minutes = Math.floor(diffMs / 60000);
                            timeText = minutes < 1 ? "< 1 min" : `${minutes} min`;
                        }
                        const score = deal.score || 50; 
                        let scoreColor = score >= 80 ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]' : (score < 45 ? 'bg-red-600' : 'bg-blue-500');
                        let listPrice = deal.price || "---";
                        if(listPrice.includes(":")) listPrice = listPrice.split(":")[1].trim();
                        
                        const dealDataEscaped = encodeURIComponent(JSON.stringify(deal))
                            .replace(/'/g, "%27")
                            .replace(/\(/g, "%28")
                            .replace(/\)/g, "%29"); 
                        
                        const isSaved = savedIds.includes(deal.id);
                        
                        let saveButtonHtml;
                        if (isSaved) {
                            saveButtonHtml = `
                            <button class="text-green-500 border border-green-500/50 bg-green-500/10 p-2 rounded-lg z-10 cursor-default" title="Already Saved">
                                <span class="font-bold text-xs">‚úì</span>
                            </button>`;
                        } else {
                            saveButtonHtml = `
                            <button onclick="saveScanFromIndex(event, '${dealDataEscaped}', this)" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition-all z-10" title="Save to Archive">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                            </button>`;
                        }

                        htmlContent += `
                            <div onclick="openDetail('${dealDataEscaped}')" class="glass-panel p-5 rounded-xl transition-all border border-white/5 hover:border-blue-500/30 new-item cursor-pointer group relative" style="opacity: ${1 - index*0.15}">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">${deal.store || 'WEB'}</span>
                                        <h3 class="text-white font-bold text-sm leading-tight mt-1 group-hover:text-blue-400 transition-colors line-clamp-2 pr-8">${deal.title || 'Product'}</h3>
                                    </div>
                                    <div class="text-[9px] font-mono text-gray-600 pt-1 whitespace-nowrap">${timeText}</div>
                                </div>
                                <div class="flex justify-between items-end mt-4">
                                    <div class="flex flex-col">
                                        <span class="text-2xl font-black text-white tracking-tighter">${listPrice}</span>
                                        <p class="text-[10px] text-gray-500 italic mt-1 max-w-[150px] truncate">"${deal.opinion}"</p>
                                    </div>
                                    
                                    <div class="flex items-center gap-2">
                                        ${saveButtonHtml}
                                        <span class="text-blue-500 text-xs font-bold uppercase tracking-widest bg-blue-500/10 px-2 py-2 rounded border border-blue-500/20 group-hover:bg-blue-500 group-hover:text-white transition-all">Detail ‚Üó</span>
                                    </div>
                                </div>
                                <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mt-3">
                                    <div class="h-full ${scoreColor} transition-all duration-1000" style="width: ${score}%"></div>
                                </div>
                            </div>`;
                    });
                    list.innerHTML = htmlContent;
                }
            } catch (e) { console.error("Fetch Error:", e); }
        }

        async function saveScanFromIndex(event, dealDataEscaped, btn) {
            event.stopPropagation(); 
            
            const token = localStorage.getItem('rr_auth_token');
            if (!token) { 
                const statusEl = document.getElementById('scanStatus');
                if (statusEl) {
                    statusEl.innerText = "‚ö†Ô∏è Please log in to save scans!";
                    statusEl.className = "text-center text-xs font-mono h-5 text-red-400";
                    setTimeout(() => { statusEl.innerText = ""; }, 3000);
                }
                return; 
            }

            const deal = JSON.parse(decodeURIComponent(dealDataEscaped));
            
            const originalContent = btn.innerHTML;
            btn.innerHTML = `‚úì`;
            btn.classList.add("text-green-500", "border-green-500/50");

            try {
                const res = await fetch('/api/save_scan', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ deal }) 
                });
                
                if(!res.ok) {
                    btn.innerHTML = originalContent;
                    btn.classList.remove("text-green-500", "border-green-500/50");

                    const statusEl = document.getElementById('scanStatus');
                    if (statusEl) {
                        statusEl.innerText = res.status === 401 ? "‚ö†Ô∏è Session expired. Log in again." : "‚ùå Save failed.";
                        statusEl.className = "text-center text-xs font-mono h-5 text-red-500";
                        setTimeout(() => { statusEl.innerText = ""; }, 3000);
                    }
                } else {
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove("text-green-500", "border-green-500/50");
                    }, 2000);
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = originalContent;
                btn.classList.remove("text-green-500", "border-green-500/50");
            }
        }

async function requestScan() {
            const query = document.getElementById('scanQuery').value;
            const customStore = document.getElementById('custom-store').value.trim();
            // P≈òID√ÅNO: Naƒçten√≠ filtr≈Ø
            const maxPrice = document.getElementById('max-price').value.trim(); 
            const condition = document.getElementById('condition').value;

            const statusEl = document.getElementById('scanStatus');
            const btn = document.getElementById('scan-btn');
            const userEmail = localStorage.getItem('rr_user_email'); 

            if(!query) { statusEl.innerText = "‚ö†Ô∏è Enter product name"; return; }
            
            isWaitingForScan = true; 
            setTimeout(() => { isWaitingForScan = false; }, 60000);
            
            // --- SCANNER MOOD START ---
            btn.disabled = true;
            statusEl.className = "text-center text-xs font-mono h-5 text-blue-400 animate-pulse";
            
            const moodMessages = [
                "> Establishing secure uplink...",
                "> Bypassing store bot-protection...",
                "> Analyzing market data...",
                "> AI evaluating deal quality...",
                "> Extracting best price..."
            ];
            let moodIndex = 0;
            statusEl.innerText = moodMessages[0];
            
            const moodInterval = setInterval(() => {
                moodIndex++;
                if (moodIndex < moodMessages.length) {
                    statusEl.innerText = moodMessages[moodIndex];
                }
            }, 1800); // Mƒõn√≠ text ka≈æd√Ωch 1.8 vte≈ôiny
            // --- SCANNER MOOD END ---

            let stores = [];
            if (customStore) stores = [customStore];
            else if (document.getElementById('check-ebay').checked) stores = ['ebay'];
            else stores = ['ebay'];
            
            try {
                // ... (tady z≈Øst√°v√° tv≈Øj p≈Øvodn√≠ fetch('/api/request_scan'... k√≥d) ...
                const response = await fetch('/api/request_scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query, 
                        stores: stores,
                        ownerEmail: userEmail || 'system' ,
                        maxPrice: maxPrice,
                        condition: condition
                    })
                });

                const data = await response.json();
                
                clearInterval(moodInterval); // Zastav√≠me rotov√°n√≠ text≈Ø

                if (response.ok) {
                    statusEl.innerText = `‚úÖ Request received! Satellites scanning ${stores[0]}...`;
                    statusEl.className = "text-center text-xs font-mono h-5 text-green-500";
                    document.getElementById('scanQuery').value = "";
                    document.getElementById('custom-store').value = "";
                } else {
                    statusEl.innerText = `‚ö†Ô∏è ${data.error || 'Limit reached'}`;
                    statusEl.className = "text-center text-xs font-mono h-5 text-red-400";
                }
            } catch (e) { 
                clearInterval(moodInterval); // Zastav√≠me i p≈ôi chybƒõ
                statusEl.innerText = "‚ùå Connection error"; 
                statusEl.className = "text-center text-xs font-mono h-5 text-red-500";
            } finally { 
                setTimeout(() => { 
                    btn.disabled = false; 
                    statusEl.innerText = ""; 
                }, 4000); 
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadLayout(); 
            initChart();
            await fetchLatestDeal();
            setInterval(fetchLatestDeal, 10000); 
        });
    function openGuide() {
            const modal = document.getElementById('guide-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modalContent.classList.remove('scale-95'); 
                modalContent.classList.add('scale-100'); 
            }, 10);
        }

        function closeGuide() {
            const modal = document.getElementById('guide-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    // --- SHARE LOGIC ---
        function shareDeal() {
            const title = document.getElementById('modal-title').innerText;
            const price = document.getElementById('modal-price').innerText;
            const store = document.getElementById('modal-badge').innerText;
            
            // Vygenerujeme hezk√Ω text pro sd√≠len√≠
            const shareText = `üî• Crazy deal on RigRadar!\n\n${title}\nüí∞ ${price} at ${store}\n\nScanner: https://rigradarai.com`;
            
            // Pokus√≠me se zkop√≠rovat do schr√°nky
            navigator.clipboard.writeText(shareText).then(() => {
                const shareBtn = document.getElementById('modal-share');
                const originalHtml = shareBtn.innerHTML;
                
                // Animace potvrzen√≠
                shareBtn.innerHTML = `<span class="text-green-400 font-bold text-sm">COPIED!</span>`;
                shareBtn.classList.add('border-green-500/50', 'bg-green-500/10');
                
                setTimeout(() => {
                    shareBtn.innerHTML = originalHtml;
                    shareBtn.classList.remove('border-green-500/50', 'bg-green-500/10');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    </script>
</body>
</html>
