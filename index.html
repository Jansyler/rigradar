<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RigRadar AI - Live Market Scanner</title>
<meta name="description" content="RigRadar AI - Autonomous hardware market scanner. Hunting for PC Hardware, and tech deals 24/7.">

<meta property="og:type" content="website">
<meta property="og:url" content="https://rigradarai.com/">
<meta property="og:title" content="RigRadar AI | Live Market Scanner">
<meta property="og:description" content="AI-driven autonomous scanner hunting for the best hardware deals 24/7.">
<meta property="og:image" content="https://rigradarai.com/social-preview.png">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="RigRadar AI | Live Market Scanner">
<meta name="twitter:description" content="AI-driven autonomous scanner hunting for the best hardware deals 24/7.">
<meta name="twitter:image" content="https://rigradarai.com/social-preview.png">
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
<link href="style.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { 
            background-color: #050505; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .new-item { animation: fadeIn 0.5s ease-out; }

        /* Support Bot Styles */
        #support-widget { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #support-widget.open { width: 350px; height: 500px; border-radius: 20px; }
        .msg-supp-ai { background: rgba(255, 255, 255, 0.1); border-radius: 12px 12px 12px 0; }
        .msg-supp-user { background: #2563eb; border-radius: 12px 12px 0 12px; }
@keyframes radar-sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .sweep-effect::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 30%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            animation: radar-sweep 4s infinite ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden">
<div id="notification-container" class="fixed top-5 right-5 z-[1000] flex flex-col gap-3 pointer-events-none"></div>

    <div id="header-placeholder"></div>
    
<main class="flex-grow flex flex-col items-center justify-start px-4 md:px-8 pt-24 pb-24 w-full max-w-[1300px] mx-auto space-y-16 overflow-hidden">
        
        <div class="text-center space-y-8 max-w-4xl mx-auto mt-8 relative">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-blue-600/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div class="inline-flex items-center gap-3 px-5 py-2 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-300 font-mono text-xs uppercase tracking-widest backdrop-blur-md shadow-[0_0_20px_rgba(59,130,246,0.15)]">
                <span class="relative flex h-2.5 w-2.5">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500"></span>
                </span>
                Global Network Online
            </div>
            <h1 class="text-5xl md:text-7xl lg:text-8xl font-black tracking-tighter pb-2 text-white drop-shadow-2xl">
                RIG<span class="text-blue-500">RADAR</span>
            </h1>
            <p class="text-blue-100/70 text-lg md:text-xl font-light max-w-2xl mx-auto leading-relaxed relative z-10">
                Autonomous satellites monitoring hardware prices 24/7. Preview the live pulse below, or enter the Workspace to deploy your own custom scans.
            </p>
            <div class="pt-8 relative z-10">
                <button onclick="location.href='chat.html'" class="sweep-effect group relative px-12 py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg md:text-xl rounded-2xl transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-3 mx-auto overflow-hidden">
                    <span class="relative z-10 uppercase tracking-widest">Enter Workspace üöÄ</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 w-full pt-8 relative z-10">
            
            <div class="glass-panel p-8 md:p-10 rounded-[32px] lg:col-span-2 flex flex-col relative overflow-hidden group min-h-[380px] border border-white/5 hover:border-blue-500/30 transition-colors">
                <div class="absolute inset-0 bg-gradient-to-b from-blue-500/5 to-transparent opacity-50"></div>
                <div class="flex justify-between items-start mb-8 relative z-10">
                    <div>
                        <h3 class="text-xs md:text-sm font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2 mb-2">
                            <span class="text-blue-500">üìà</span> Market Trend
                        </h3>
                        <h2 id="chart-title" class="text-3xl font-black text-white truncate">Gathering data...</h2>
                    </div>
                    <span class="text-xs font-mono bg-blue-500/10 border border-blue-500/20 px-4 py-2 rounded-xl text-blue-400 flex items-center gap-3 shadow-lg">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> Live
                    </span>
                </div>
                <div class="w-full h-full min-h-[220px] relative z-10">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-[32px] lg:col-span-1 flex flex-col justify-between relative overflow-hidden group cursor-pointer border border-blue-500/20 hover:border-blue-400/50 transition-all min-h-[380px]" onclick="location.href='chat.html'">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-xs font-bold uppercase tracking-widest bg-blue-500/20 text-blue-400 px-4 py-2 rounded-full border border-blue-500/30 flex items-center gap-2">
                            <span class="text-sm">üéØ</span> Top Catch
                        </span>
                        <span id="top-catch-store" class="text-xs text-blue-200/50 font-mono uppercase tracking-widest">Scanning...</span>
                    </div>
                    <h3 id="top-catch-title" class="text-2xl font-bold text-white leading-tight mb-4 line-clamp-2">Waiting for satellite data...</h3>
                    <div class="flex items-end gap-4 mb-4">
                        <span id="top-catch-price" class="text-5xl font-black text-blue-400 tracking-tighter">--</span>
                    </div>
                </div>
                
                <div class="relative z-10 mt-auto">
                    <div class="bg-blue-950/20 border border-blue-500/20 rounded-2xl p-5 backdrop-blur-md">
                        <div class="text-[10px] text-blue-400 uppercase font-bold tracking-widest mb-2 flex items-center gap-2"><span>ü§ñ</span> AI Verdict</div>
                        <p id="top-catch-opinion" class="text-sm text-blue-100/70 italic leading-relaxed line-clamp-2">"Analyzing market position..."</p>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8 md:p-10 rounded-[32px] lg:col-span-2 flex flex-col min-h-[400px] border border-blue-500/30 shadow-[0_0_30px_rgba(59,130,246,0.05)] relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-b from-blue-900/10 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-center mb-6 relative z-10 px-1 border-b border-white/5 pb-4">
                    <h3 class="text-base md:text-lg font-bold text-blue-400 uppercase tracking-widest flex items-center gap-3">
                        <span class="text-xl">üì°</span> Live Market Feed
                    </h3>
                    <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-ping"></span>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto space-y-4 pr-3 relative z-10 custom-scrollbar">
                    <div class="text-center text-blue-200/50 text-sm py-10 animate-pulse">Intercepting signals...</div>
                </div>
                <div class="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-[#050505] to-transparent z-20 pointer-events-none rounded-b-[32px]"></div>
            </div>

            <div class="glass-panel p-6 rounded-[32px] lg:col-span-1 flex flex-col h-full min-h-[400px] relative overflow-hidden border border-white/5 bg-[#0a0a0a]">
                <div class="flex items-center gap-2 mb-4 px-2 relative z-10">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span class="ml-2 text-[10px] font-mono text-gray-600 uppercase">satellite_log.sh</span>
                </div>
                <div class="flex-1 font-mono text-xs text-blue-400/80 leading-relaxed overflow-hidden relative z-10">
                    <div class="absolute bottom-0 w-full h-12 bg-gradient-to-t from-[#0a0a0a] to-transparent z-20"></div>
                    <div class="space-y-2 opacity-70">
                        <p>> Target: Amazon DE API.</p>
                        <p>> Bypassing captcha [OK]</p>
                        <p>> Extracted 42 new listings.</p>
                        <p>> Running AI evaluation...</p>
                        <p class="text-white">> Anomaly found: 7800X3D</p>
                        <p>> Pushing to global Redis...</p>
                        <p>> Connecting to eBay Node...</p>
                        <p>> Scraping auctions [OK]</p>
                        <p class="animate-pulse">_</p>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8 md:p-10 rounded-[32px] lg:col-span-2 flex flex-col justify-center relative overflow-hidden group border border-blue-500/10 hover:border-blue-500/40 transition-all cursor-pointer min-h-[350px]" onclick="location.href='chat.html'">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-900/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                
                <div class="relative z-10 w-full flex flex-col lg:flex-row items-center justify-between gap-8 md:gap-12">
                    <div class="flex-1 space-y-5">
                        <h3 class="text-xs md:text-sm font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-3">
                            <span class="text-blue-500 text-xl">üí¨</span> AI Workspace
                        </h3>
                        <h4 class="text-3xl md:text-4xl font-black text-white leading-tight tracking-tight">Unsure what to buy?<br>Let AI decide.</h4>
                        <p class="text-blue-100/60 text-base leading-relaxed max-w-md">Our AI advisor analyzes your budget, suggests the perfect build, and instantly commands the radar to find the cheapest parts across the web.</p>
                    </div>
                    
                    <div class="flex-1 w-full space-y-4 pt-4 lg:pt-0">
                        <div class="bg-blue-600 text-white text-sm p-5 rounded-3xl rounded-tr-none self-end ml-auto max-w-[90%] shadow-lg shadow-blue-900/20">
                            Building a 1440p rig. RTX 4070 or 7800 XT?
                        </div>
                        <div class="bg-[#111] border border-blue-500/20 text-gray-200 text-sm p-5 rounded-3xl rounded-tl-none max-w-[95%] relative shadow-2xl">
                            <div class="absolute -left-1.5 -top-1.5 w-3 h-3 bg-blue-500 rounded-full animate-pulse border-2 border-[#050505]"></div>
                            Based on live scans, the <span class="text-white font-bold">7800 XT is $80 cheaper</span> today. I recommend... <span class="text-blue-400 font-bold ml-1 opacity-70 animate-pulse">typing_</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-[32px] lg:col-span-1 flex flex-col justify-center relative overflow-hidden border border-white/5 group hover:border-blue-500/30 transition-colors cursor-pointer min-h-[350px]" onclick="location.href='chat.html'">
                <div class="absolute right-0 top-0 w-full h-1/2 bg-gradient-to-b from-blue-900/10 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-center mb-6 relative z-10">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
                        <span class="text-blue-400 text-base">‚öñÔ∏è</span> Arbitrage
                    </h3>
                </div>
                
                <div class="flex flex-col gap-4 relative z-10 w-full mt-2">
                    <div class="bg-[#111] border border-blue-500/20 rounded-2xl p-4 flex items-center justify-between relative shadow-[0_0_15px_rgba(59,130,246,0.1)]">
                        <div class="absolute -top-2 left-3 bg-blue-600 text-white text-[8px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full shadow-lg">Best Deal</div>
                        <span class="text-xs text-blue-200/50 font-mono uppercase">Amazon</span>
                        <span class="text-xl font-black text-white">$899</span>
                    </div>
                    <div class="bg-[#111] border border-white/10 rounded-2xl p-4 flex items-center justify-between opacity-80">
                        <span class="text-xs text-gray-500 font-mono uppercase">eBay (Used)</span>
                        <span class="text-xl font-black text-gray-300">$849</span>
                    </div>
                    <div class="bg-[#111] border border-white/10 rounded-2xl p-4 flex items-center justify-between opacity-50 relative">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-2xl backdrop-blur-[1px]">
                            <span class="text-red-400 text-[9px] font-bold uppercase tracking-widest border border-red-500/30 bg-red-500/10 px-2 py-0.5 rounded">Overpriced</span>
                        </div>
                        <span class="text-xs text-gray-500 font-mono uppercase">Alza</span>
                        <span class="text-xl font-black text-gray-500">$1,050</span>
                    </div>
                </div>
                <div class="mt-6 text-center text-[10px] text-blue-100/50 italic leading-relaxed">
                    AI detected a <span class="text-white font-bold">$151 spread</span> on RTX 4080 Super.
                </div>
            </div>

        </div>

        <div id="detail-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-all opacity-0">
            <div class="glass-panel w-full max-w-lg rounded-[32px] p-8 relative border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.2)] transform scale-95 transition-all duration-300">
                <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl">‚úï</button>
                <div id="modal-badge" class="inline-block px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] uppercase font-bold mb-4 tracking-widest">STORE</div>
                <h2 id="modal-title" class="text-2xl font-black text-white leading-tight mb-2">---</h2>
                <div id="modal-price" class="text-5xl font-black text-blue-500 tracking-tighter mb-6">$---</div>
                <div class="space-y-4">
                    <div class="flex justify-between text-[10px] uppercase font-bold text-gray-500 mb-2"><span>AI Deal Score</span><span id="modal-score-val">---%</span></div>
                    <div class="h-2 bg-black/40 rounded-full overflow-hidden border border-white/5"><div id="modal-score-bar" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div></div>
                    <div class="pt-4 border-t border-white/5"><div class="text-[10px] uppercase font-bold text-blue-400 mb-2 font-mono">Full AI Analysis</div><p id="modal-opinion" class="text-gray-300 italic leading-relaxed text-sm">---</p></div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button id="modal-share" onclick="shareDeal()" class="bg-white/5 hover:bg-white/10 border border-white/10 hover:border-blue-500/30 text-gray-300 hover:text-white font-bold py-4 px-6 rounded-2xl flex items-center justify-center gap-2 transition-all">
                        <span class="text-lg">üîó</span>
                    </button>
                    <a id="modal-link" href="#" target="_blank" class="flex-grow bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-center uppercase text-sm tracking-wider">GO TO STORE ‚Üó</a>
                </div>
            </div>
        </div>

        <div id="support-widget" class="fixed bottom-6 right-6 z-[200] w-14 h-14 bg-blue-600/20 text-blue-400 rounded-full border border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)] backdrop-blur-md overflow-hidden flex flex-col transition-all duration-300">
            <div onclick="toggleSupport()" class="w-full h-14 min-h-[56px] flex items-center justify-center cursor-pointer hover:bg-blue-600/40 transition-all absolute top-0 left-0 z-20 group">
                <span id="supp-icon-open" class="text-2xl group-hover:scale-110 transition-transform">üí¨</span>
                <span id="supp-icon-close" class="text-xl font-black hidden group-hover:scale-110 transition-transform text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">‚úï</span>
            </div>
            <div class="flex-1 bg-[#050505]/95 flex flex-col pt-14 opacity-0 transition-opacity duration-300 backdrop-blur-md" id="supp-body">
                <div class="p-3 border-b border-blue-500/20 text-center">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-blue-400 drop-shadow-[0_0_8px_rgba(96,165,250,0.8)]">AI Advisor</h4>
                </div>
                <div id="supp-messages" class="flex-1 overflow-y-auto p-4 space-y-3 text-xs">
                    <div class="msg-supp-ai p-3 text-gray-300 border border-blue-500/20 shadow-[0_0_10px_rgba(37,99,235,0.1)]">Hi! üëã Need help with your build?</div>
                </div>
                <div class="p-3 bg-black/80 border-t border-blue-500/20 flex gap-2">
                    <input id="supp-input" type="text" placeholder="Type here..." onkeypress="if(event.key==='Enter') sendSupportMsg()" class="flex-1 bg-transparent text-white text-xs outline-none">
                    <button onclick="sendSupportMsg()" class="text-blue-500 font-bold text-xs hover:text-cyan-400 transition-colors drop-shadow-[0_0_5px_rgba(96,165,250,0.5)]">SEND</button>
                </div>
            </div>
        </div>
        
        <button onclick="openGuide()" class="fixed bottom-6 left-6 w-14 h-14 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-full border border-blue-500/50 flex items-center justify-center text-2xl font-black backdrop-blur-md transition-all z-[90] shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)] group">
            <span class="group-hover:scale-110 transition-transform">?</span>
        </button>

        <div id="guide-modal" class="fixed inset-0 z-[400] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-all opacity-0">
            <div class="glass-panel w-full max-w-lg rounded-[32px] p-8 relative border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.2)] transform scale-95 transition-all duration-300">
                <button onclick="closeGuide()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl">‚úï</button>
                <div class="inline-block px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] uppercase font-bold mb-4 tracking-widest">
                    Quick Start Guide
                </div>
                <h2 class="text-2xl font-black text-white leading-tight mb-4">How to use RigRadar üì°</h2>
                <p class="text-gray-300 text-sm font-light leading-relaxed mb-6">
                    Simply type the hardware you want (e.g. <span class="text-blue-400 font-mono">RTX 4070</span>), specify a store, and our satellite will autonomously hunt down the absolute best deals in real-time.
                </p>
                <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-2xl mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-[40px] rounded-full pointer-events-none"></div>
                    <div class="flex items-start gap-3 relative z-10">
                        <span class="text-2xl">üí°</span>
                        <div>
                            <h4 class="text-blue-400 font-bold text-sm uppercase tracking-wider mb-1">Pro-Tip: Ask AI First!</h4>
                            <p class="text-xs text-gray-400 leading-relaxed">
                                Don't know what to build? Open <b class="text-white">Workspace</b> (top menu). Our AI will recommend the best PC build for your budget and tell you exactly which stores to scan!
                            </p>
                        </div>
                    </div>
                </div>
                <button onclick="closeGuide()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-center uppercase text-sm tracking-wider transition-all shadow-lg shadow-blue-900/20">
                    GOT IT, LET'S SCAN üöÄ
                </button>
            </div>
        </div>
    </main>
    <div id="footer-placeholder"></div>

    <script src="auth.js"></script>
<script>
// --- SUPPORT BOT LOGIC ---
    let supportHistory = [];
    
    function toggleSupport() {
        const widget = document.getElementById('support-widget');
        const body = document.getElementById('supp-body');
        const iconOpen = document.getElementById('supp-icon-open');
        const iconClose = document.getElementById('supp-icon-close');
        widget.classList.toggle('open');
        
        if (widget.classList.contains('open')) {
            body.classList.remove('opacity-0');
            iconOpen.classList.add('hidden');
            iconClose.classList.remove('hidden');
        } else {
            body.classList.add('opacity-0');
            iconOpen.classList.remove('hidden');
            iconClose.classList.add('hidden');
        }
    }

    async function sendSupportMsg() {
        const input = document.getElementById('supp-input');
        const msg = input.value.trim();
        if (!msg) return;
        const chat = document.getElementById('supp-messages');
        chat.innerHTML += `<div class="msg-supp-user p-3 text-white self-end ml-auto max-w-[85%]">${msg}</div>`;
        input.value = '';
        chat.scrollTop = chat.scrollHeight;
        supportHistory.push({ role: 'user', text: msg });

        try {
            const res = await fetch('/api/support', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg, history: supportHistory })
            });
            const data = await res.json();
            chat.innerHTML += `<div class="msg-supp-ai p-3 text-gray-300 max-w-[85%]">${data.text}</div>`;
            supportHistory.push({ role: 'ai', text: data.text });
            chat.scrollTop = chat.scrollHeight;
        } catch (e) {
            chat.innerHTML += `<div class="msg-supp-ai p-3 text-red-400">Connection failed.</div>`;
        }
    }

    // --- NOTIFICATIONS, MODAL & CHART LOGIC ---
    let lastNotifiedId = null;
    let isFirstLoad = true;
    let isWaitingForScan = false;
    let priceChartInstance = null;

    function initChart() {
        const canvas = document.getElementById('priceChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

        priceChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Price', data: [], borderColor: '#3b82f6', backgroundColor: gradient, fill: true, tension: 0.3 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#666', font: { size: 10 } } },
                    y: { display: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#666' } }
                }
            }
        });
    }

    function openDetail(dealDataEscaped) {
        try {
            const deal = JSON.parse(decodeURIComponent(dealDataEscaped));
            const modal = document.getElementById('detail-modal');
            const modalContent = modal.querySelector('div');
            
            document.getElementById('modal-title').innerText = deal.title || "Product Detail";
            document.getElementById('modal-price').innerText = deal.price || "---";
            document.getElementById('modal-opinion').innerText = deal.opinion || "No analysis available.";
            document.getElementById('modal-badge').innerText = (deal.store || "WEB").toUpperCase();
            
            const score = deal.score || 50;
            document.getElementById('modal-score-val').innerText = score + '%';
            document.getElementById('modal-score-bar').style.width = score + '%';
            
            const link = document.getElementById('modal-link');
            if (deal.url && deal.url !== "#") { link.href = deal.url; link.classList.remove('hidden'); } 
            else { link.classList.add('hidden'); }

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        } catch (e) { console.error("Error opening detail:", e); }
    }

    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const modalContent = modal.querySelector('div');
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showRigNotification(title, price, deal) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = "glass-panel pointer-events-auto p-4 rounded-2xl shadow-2xl transform translate-x-full transition-all duration-500 ease-out cursor-pointer hover:border-blue-500/50 min-w-[280px] border border-white/5";
        notification.style.background = "rgba(10, 10, 10, 0.9)";
        notification.innerHTML = `
            <div class="flex items-center gap-4">
                <div class="bg-blue-600/20 p-2 rounded-lg text-blue-400">üì°</div>
                <div class="flex-grow">
                    <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Satellite Found Deal</p>
                    <p class="text-sm font-bold text-white truncate w-48">${title}</p>
                    <p class="text-lg font-black text-green-400 mt-1">${price}</p>
                </div>
            </div>`;
        notification.onclick = () => { openDetail(encodeURIComponent(JSON.stringify(deal))); notification.remove(); };
        container.appendChild(notification);
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => { notification.classList.add('translate-x-[150%]'); setTimeout(() => notification.remove(), 500); }, 6000);
    }

    function checkNotifications(deal) {
        if (!deal || !deal.id) return;
        if (isFirstLoad) { lastNotifiedId = deal.id; isFirstLoad = false; return; }
        if (lastNotifiedId !== deal.id) {
            lastNotifiedId = deal.id;
            if (isWaitingForScan) {
                showRigNotification(deal.title, deal.price, deal);
                isWaitingForScan = false;
            }
        }
    }

    async function fetchLatestDeal() {
        try {
            const userEmail = localStorage.getItem('rr_user_email');
            const res = await fetch(`/api/update_price${userEmail ? '?user='+userEmail : ''}`);
            const data = await res.json();
            
            if (data.history && data.history.length > 0) checkNotifications(data.history[0]);

            const list = document.getElementById('history-list');
            const savedIds = (data.saved || []).map(s => s.id);

            if (list && data.history) {
                let htmlContent = '';
                data.history.slice(0, 5).forEach((deal, index) => {
                    const diffMs = Date.now() - (deal.timestamp || Date.now());
                    const timeText = Math.floor(diffMs / 60000) < 1 ? "< 1 min" : `${Math.floor(diffMs / 60000)} min`;
                    const score = deal.score || 50;
                    const scoreColor = score >= 80 ? 'bg-green-500' : (score < 45 ? 'bg-red-600' : 'bg-blue-500');
                    const dealEsc = encodeURIComponent(JSON.stringify(deal)).replace(/'/g, "%27");
                    const isSaved = savedIds.includes(deal.id);
                    
                    htmlContent += `
                        <div onclick="openDetail('${dealEsc}')" class="glass-panel p-5 rounded-xl transition-all border border-white/5 hover:border-blue-500/30 cursor-pointer group relative" style="opacity: ${1 - index*0.15}">
                            <div class="flex justify-between items-start">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-blue-400 font-bold uppercase">${deal.store || 'WEB'}</span>
                                    <h3 class="text-white font-bold text-sm leading-tight mt-1 group-hover:text-blue-400 line-clamp-2 pr-8">${deal.title}</h3>
                                </div>
                                <div class="text-[9px] font-mono text-gray-600 pt-1">${timeText}</div>
                            </div>
                            <div class="flex justify-between items-end mt-4">
                                <span class="text-2xl font-black text-white tracking-tighter">${deal.price}</span>
                                <div class="flex items-center gap-2">
                                    ${isSaved ? '<button class="text-green-500 border border-green-500/50 bg-green-500/10 p-2 rounded-lg">‚úì</button>' : 
                                    `<button onclick="saveScanFromIndex(event, '${dealEsc}', this)" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition-all">üíæ</button>`}
                                    <span class="text-blue-500 text-xs font-bold uppercase tracking-widest bg-blue-500/10 px-2 py-2 rounded border border-blue-500/20">Detail ‚Üó</span>
                                </div>
                            </div>
                            <div class="w-full h-1 bg-white/5 rounded-full mt-3 overflow-hidden">
                                <div class="h-full ${scoreColor}" style="width: ${score}%"></div>
                            </div>
                        </div>`;
                });
                list.innerHTML = htmlContent;
            }
        } catch (e) { console.error("Fetch Error:", e); }
    }

    async function saveScanFromIndex(event, dealDataEscaped, btn) {
        event.stopPropagation();
        const token = localStorage.getItem('rr_auth_token');
        if (!token) { alert("Log in to save scans!"); return; }
        const deal = JSON.parse(decodeURIComponent(dealDataEscaped));
        btn.innerHTML = `‚úì`;
        btn.classList.add("text-green-500");

        try {
            const res = await fetch('/api/save_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ deal })
            });
            if (!res.ok) throw new Error();
        } catch (e) { btn.innerHTML = "üíæ"; btn.classList.remove("text-green-500"); }
    }

    async function requestScan() {
        const query = document.getElementById('scanQuery').value;
        const customStore = document.getElementById('custom-store').value.trim();
        const maxPrice = document.getElementById('max-price').value.trim();
        const condition = document.getElementById('condition-val').value;
        const statusEl = document.getElementById('scanStatus');
        const btn = document.getElementById('scan-btn');
        const token = localStorage.getItem('rr_auth_token');

        if(!query) { statusEl.innerText = "‚ö†Ô∏è Enter product name"; return; }
        isWaitingForScan = true;
        btn.disabled = true;
        statusEl.className = "text-center text-xs font-mono h-5 text-blue-400 animate-pulse";
        
        const moodMessages = ["> Secure uplink...", "> Store scan...", "> AI Extracting..."];
        let moodIdx = 0; statusEl.innerText = moodMessages[0];
        const moodInterval = setInterval(() => { moodIdx++; if (moodIdx < moodMessages.length) statusEl.innerText = moodMessages[moodIdx]; }, 1800);

        try {
            const res = await fetch('/api/request_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ query, stores: customStore ? [customStore] : ['ebay'], maxPrice, condition, ownerEmail: localStorage.getItem('rr_user_email') || 'system' })
            });
            const data = await res.json();
            clearInterval(moodInterval);
            if (res.ok) {
                statusEl.innerText = "‚úÖ Satellite deployed!";
                statusEl.className = "text-center text-xs font-mono h-5 text-green-500";
            } else { statusEl.innerText = `‚ö†Ô∏è ${data.error || 'Error'}`; statusEl.className = "text-center text-xs font-mono h-5 text-red-400"; }
        } catch (e) { clearInterval(moodInterval); statusEl.innerText = "‚ùå Connection error"; } 
        finally { setTimeout(() => { btn.disabled = false; statusEl.innerText = ""; }, 4000); }
    }

    function setCondition(value, clickedBtn) {
        document.getElementById('condition-val').value = value;
        document.querySelectorAll('.cond-btn').forEach(btn => btn.className = "cond-btn flex-1 py-2.5 text-[10px] md:text-xs font-bold uppercase tracking-widest rounded-lg bg-transparent text-gray-500 hover:text-gray-300 border border-transparent");
        clickedBtn.className = "cond-btn flex-1 py-2.5 text-[10px] md:text-xs font-bold uppercase tracking-widest rounded-lg bg-blue-600/30 text-white border border-blue-500/50 shadow-[0_0_10px_rgba(37,99,235,0.2)]";
    }

    function openGuide() {
        const modal = document.getElementById('guide-modal');
        const modalContent = modal.querySelector('div');
        modal.classList.remove('hidden');
        setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
    }

    function closeGuide() {
        const modal = document.getElementById('guide-modal');
        const modalContent = modal.querySelector('div');
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function shareDeal() {
        const title = document.getElementById('modal-title').innerText;
        const price = document.getElementById('modal-price').innerText;
        const shareText = `üî• Crazy deal on RigRadar!\n\n${title}\nüí∞ ${price}\n\nScanner: https://rigradarai.com`;
        navigator.clipboard.writeText(shareText).then(() => {
            const shareBtn = document.getElementById('modal-share');
            const orig = shareBtn.innerHTML;
            shareBtn.innerHTML = `<span class="text-green-400 text-sm">COPIED!</span>`;
            setTimeout(() => shareBtn.innerHTML = orig, 2000);
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadLayout(); 
        initChart();
        await fetchLatestDeal();
        setInterval(fetchLatestDeal, 15000); 
    });
</body>
</html>
