<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Scans - RigRadar AI</title>
    <link rel="icon" type="image/png" href="logo.png">
<link href="style.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { 
            background-color: #050505; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .tab-active { border-bottom: 2px solid #2563eb; color: white; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="flex-grow max-w-5xl mx-auto w-full px-4 pt-24 pb-20">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase">My <span class="text-blue-600">Archive</span></h1>
                <p class="text-gray-400 text-sm mt-1">Manage your scan history and saved deals.</p>
            </div>
            
            <div class="flex gap-6 border-b border-white/10 w-full md:w-auto">
                <button onclick="switchTab('history')" id="tab-history" class="pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-active">
                    Recent Scans
                </button>
                <button onclick="switchTab('saved')" id="tab-saved" class="pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-inactive">
                    Saved Collection
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-20 text-gray-500 animate-pulse">Loading archive...</div>

        <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
        </div>

        <div id="empty-state" class="hidden text-center py-20">
            <div class="text-4xl mb-4">üìÇ</div>
            <h3 class="text-white font-bold">Nothing here yet</h3>
            <p class="text-gray-500 text-sm mb-6">Start scanning hardware to fill your history.</p>
            <a href="/" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition-all text-sm">Start Scanning</a>
        </div>

    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-[#1a1a1a] border border-white/10 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300">
        <span id="toast-icon">üíæ</span> <span id="toast-msg" class="text-sm font-bold">Saved!</span>
    </div>

    <div id="delete-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity opacity-0">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 text-center border border-red-500/20 shadow-[0_0_50px_rgba(220,38,38,0.1)] transform scale-95 transition-all duration-300">
            
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                <span class="text-3xl">üóë</span>
            </div>
            
            <h3 class="text-xl font-bold text-white mb-2">Remove Item?</h3>
            <p class="text-gray-400 text-sm mb-6 leading-relaxed">
                Are you sure you want to remove this item from your saved collection?
            </p>
            
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white/5 hover:bg-white/10 text-gray-300 transition-all">
                    Cancel
                </button>
                <button onclick="confirmDelete()" id="btn-confirm-delete" class="flex-1 py-3 rounded-xl font-bold text-sm bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/20 transition-all">
                    Yes, Remove
                </button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        let userData = { history: [], saved: [] };
        let currentTab = 'history';

        async function loadData() {
            const email = localStorage.getItem('rr_user_email');
            if(!email) { window.location.href = '/'; return; }

            try {
                const res = await fetch(`/api/update_price?user=${email}`);
                const data = await res.json();
                
                userData.history = data.userHistory || [];
                userData.saved = data.saved || [];
                render();
            } catch (e) { console.error(e); }
        }

        function render() {
            document.getElementById('loading').classList.add('hidden');
            const grid = document.getElementById('content-grid');
            const empty = document.getElementById('empty-state');
            
            const items = currentTab === 'history' ? userData.history : userData.saved;
            
            if (items.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            empty.classList.add('hidden');
            grid.innerHTML = '';

            items.forEach(deal => {
                const isAlreadySaved = userData.saved.some(s => s.id === deal.id);
                const card = document.createElement('div');
                card.className = "glass-panel p-5 rounded-2xl border border-white/5 hover:border-blue-500/30 transition-all group relative";
                
                let scoreColor = (deal.score || 50) >= 80 ? 'bg-green-500' : 'bg-blue-500';
                
                // ROZHODOV√ÅN√ç O TLAƒå√çTKU PODLE Z√ÅLO≈ΩKY
                let actionBtn = '';
                
                if (currentTab === 'history') {
                    // Z√°lo≈æka HISTORIE: Tlaƒç√≠tko SAVE
                    if (isAlreadySaved) {
                        actionBtn = `<span class="text-green-500 text-xs font-bold flex items-center gap-1 border border-green-500/30 px-2 py-1.5 rounded-lg bg-green-500/10">‚úì Saved</span>`;
                    } else {
                        const dealStr = encodeURIComponent(JSON.stringify(deal));
                        actionBtn = `<button onclick="saveDeal('${dealStr}', this)" class="bg-white/10 hover:bg-white/20 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-all flex items-center gap-2"><span>üíæ</span> SAVE</button>`;
                    }
                } else {
                    // Z√°lo≈æka ULO≈ΩEN√â: Tlaƒç√≠tko DELETE (Otev≈ôe Modal)
                    actionBtn = `<button onclick="openDeleteModal('${deal.id}', this)" class="bg-red-500/10 hover:bg-red-500/30 text-red-500 hover:text-red-400 text-xs font-bold px-3 py-1.5 rounded-lg transition-all flex items-center gap-2 border border-red-500/20"><span>üóë</span> REMOVE</button>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">${deal.store || 'WEB'}</span>
                        <span class="text-[10px] text-gray-500 font-mono">${new Date(deal.timestamp).toLocaleDateString()}</span>
                    </div>
                    
                    <h3 class="text-white font-bold text-sm leading-tight mb-4 line-clamp-2 h-10">${deal.title}</h3>
                    
                    <div class="flex items-end justify-between">
                        <div class="text-2xl font-black text-white tracking-tighter">${deal.price}</div>
                        <div class="flex gap-2 items-center">
                            ${actionBtn}
                            <a href="${deal.url}" target="_blank" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-all">OPEN ‚Üó</a>
                        </div>
                    </div>
                    
                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mt-4">
                        <div class="h-full ${scoreColor}" style="width: ${deal.score}%"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // FUNKCE PRO ULO≈ΩEN√ç (z historie)
 // FUNKCE PRO ULO≈ΩEN√ç (z historie)
        async function saveDeal(dealStr, btn) {
            const deal = JSON.parse(decodeURIComponent(dealStr));
            const token = localStorage.getItem('rr_auth_token'); // 1. ZMƒöNA: Pou≈æ√≠v√°me token
            
            if (!token) return;

            btn.innerHTML = "...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/save_scan', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                       
                    },
                    body: JSON.stringify({ deal }) // 3. ZMƒöNA: Pos√≠l√°me jen deal
                });
                
                if (res.ok) {
                    loadData(); 
                    showToast("Scan saved to collection!", "success");
                } else {
                    throw new Error("Failed to save");
                }
            } catch (e) {
                btn.innerHTML = "Error";
                showToast("Failed to save", "error");
            }
        }

        // --- MAZ√ÅN√ç (CUSTOM MODAL) ---
        let pendingDeleteId = null;
        let pendingDeleteBtn = null;

        function openDeleteModal(dealId, btn) {
            pendingDeleteId = dealId;
            pendingDeleteBtn = btn;
            const modal = document.getElementById('delete-modal');
            const content = modal.querySelector('.glass-panel');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            const content = modal.querySelector('.glass-panel');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                pendingDeleteId = null;
                pendingDeleteBtn = null;
            }, 300);
        }

async function confirmDelete() {
            if (!pendingDeleteId || !pendingDeleteBtn) return;
            const confirmBtn = document.getElementById('btn-confirm-delete');
            const originalText = confirmBtn.innerText;
            confirmBtn.innerText = "Deleting...";
            confirmBtn.disabled = true;

            // üö® OPRAVA: Pou≈æ√≠v√°me zabezpeƒçen√Ω token m√≠sto e-mailu v body
            const token = localStorage.getItem('rr_auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch('/api/unsave_scan', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // üîí Zabezpeƒçen√© ovƒõ≈ôen√≠
                    },
                    body: JSON.stringify({ dealId: pendingDeleteId }) // Pos√≠l√°me u≈æ jen ID
                });

                if (res.ok) {
                    showToast("Removed from collection.", "success");
                    const card = pendingDeleteBtn.closest('.glass-panel');
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    
                    // Odstran√≠me polo≈æku z lok√°ln√≠ch dat, aby se p≈ôi renderu znovu neobjevila
                    userData.saved = userData.saved.filter(s => s.id !== pendingDeleteId);
                    
                    setTimeout(() => { render(); }, 500);
                } else {
                    throw new Error("Failed to remove");
                }
            } catch (e) {
                showToast("Failed to remove", "error");
            } finally {
                confirmBtn.innerText = originalText;
                confirmBtn.disabled = false;
                closeDeleteModal();
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-history').className = tab === 'history' ? 'pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-active' : 'pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-inactive hover:text-white';
            document.getElementById('tab-saved').className = tab === 'saved' ? 'pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-active' : 'pb-2 font-bold text-sm tracking-wider uppercase transition-all tab-inactive hover:text-white';
            render();
        }

        // --- KL√çƒåOV√ù SPOU≈†Tƒöƒå STR√ÅNKY ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Naƒçte spoleƒçn√Ω header/footer z auth.js
            await loadLayout();
            // 2. Naƒçte data z archivu u≈æivatele
            loadData();
        });
    </script>
</body>
</html>
